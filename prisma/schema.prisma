// =========================================================
// RENTVERSE DATABASE SCHEMA (v4.1 - TRUST & NOTIFICATIONS)
// =========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// 1. MODULE: IDENTITY & ACCESS (RBAC + User Profile)
// =========================================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  emailVerifiedAt DateTime?

  phone           String?   @unique
  phoneVerifiedAt DateTime?

  name            String?
  password        String
  avatarUrl       String?
  isVerified      Boolean   @default(false)

  // Flexible Metadata (Preferences, Social Links, etc.)
  metadata        Json?

  // Relations
  roles           UserRole[]
  tenantProfile   TenantTrustProfile?
  landlordProfile LandlordTrustProfile?
  favorites       UserFavorite[]
  
  // [NEW] Push Notification Devices
  devices         UserDevice[]

  // Chat Relations
  tenantChats     ChatRoom[]            @relation("TenantChats")
  landlordChats   ChatRoom[]            @relation("LandlordChats")
  
  bookings        Booking[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  @@map("users")
  @@index([email])
  @@index([phone])
}

// [NEW] Stores FCM Tokens for Mobile Notifications
model UserDevice {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fcmToken     String   @unique // Firebase Cloud Messaging Token
  platform     String   // "ANDROID", "IOS", "WEB"
  deviceModel  String?  // e.g. "iPhone 13"
  
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
  @@map("user_devices")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique // "TENANT", "LANDLORD", "ADMIN"
  description String?

  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  action      String           @unique // "trust.score.update", "property.create"
  description String?

  roles       RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =========================================================
// 2. MODULE: RENTAL & MARKETPLACE (Normalized EAV)
// =========================================================

model PropertyType {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  label      String
  properties Property[]

  @@map("ref_property_types")
}

model ListingType {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  label      String
  properties Property[]

  @@map("ref_listing_types")
}

model BillingPeriod {
  id             Int                     @id @default(autoincrement())
  slug           String                  @unique
  label          String
  durationMonths Int
  bookings       Booking[]
  properties     PropertyBillingPeriod[]

  @@map("ref_billing_periods")
}

model PropertyAttributeType {
  id       Int                 @id @default(autoincrement())
  slug     String              @unique
  label    String
  dataType String
  iconUrl  String?
  values   PropertyAttribute[]

  @@map("ref_property_attribute_types")
}

model PropertyAttribute {
  id              String                @id @default(uuid())
  propertyId      String
  property        Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  attributeTypeId Int
  attributeType   PropertyAttributeType @relation(fields: [attributeTypeId], references: [id])
  value           String

  @@unique([propertyId, attributeTypeId])
  @@map("property_attributes")
}

model Property {
  id          String  @id @default(uuid())
  landlordId  String
  title       String
  description String? @db.Text

  propertyTypeId Int
  propertyType   PropertyType @relation(fields: [propertyTypeId], references: [id])

  attributes PropertyAttribute[]
  amenities  String[] @default([])

  address   String
  city      String
  country   String
  latitude  Float?
  longitude Float?

  listingTypeId Int
  listingType   ListingType @relation(fields: [listingTypeId], references: [id])
  price         Decimal     @db.Decimal(15, 2)
  currency      String      @default("IDR")
  isVerified    Boolean     @default(false)

  metadata Json?

  allowedBillingPeriods PropertyBillingPeriod[]
  images                PropertyImage[]
  bookings              Booking[]
  chatRooms             ChatRoom[]
  favoritedBy           UserFavorite[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([city])
  @@index([price])
  @@index([landlordId])
  @@index([deletedAt])
  @@map("properties")
}

model PropertyBillingPeriod {
  propertyId      String
  billingPeriodId Int
  property        Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  billingPeriod   BillingPeriod @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)

  @@id([propertyId, billingPeriodId])
  @@map("property_billing_periods")
}

model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  url        String
  isPrimary  Boolean  @default(false)

  @@map("property_images")
}

model UserFavorite {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@index([userId])
  @@map("user_favorites")
}

// =========================================================
// 3. MODULE: PAYMENT & BOOKING
// =========================================================

model Booking {
  id    String @id @default(uuid())
  
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])
  tenantId   String
  tenant     User     @relation(fields: [tenantId], references: [id])

  billingPeriodId Int
  billingPeriod   BillingPeriod @relation(fields: [billingPeriodId], references: [id])

  startDate       DateTime
  endDate         DateTime?
  nextPaymentDate DateTime
  status          String // ACTIVE, CANCELLED, COMPLETED, PENDING_PAYMENT

  invoices Invoice[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([tenantId])
  @@index([propertyId])
  @@map("bookings")
}

model Invoice {
  id              String    @id @default(uuid())
  bookingId       String
  booking         Booking   @relation(fields: [bookingId], references: [id])
  amount          Decimal   @db.Decimal(15, 2)
  dueDate         DateTime
  paidAt          DateTime?
  status          String    // PENDING, PAID, OVERDUE, CANCELLED
  paymentLink     String?
  snapToken       String?
  midtransOrderId String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([status])
  @@map("invoices")
}

// =========================================================
// 4. MODULE: TRUST ENGINE (SCORING & KYC)
// =========================================================

model TrustEvent {
  id          String   @id @default(uuid())
  code        String   @unique
  category    String
  role        String
  baseImpact  Float
  description String?
  
  // [NEW] Categorize the rule type
  sourceType  String   @default("AUTOMATED") // AUTOMATED, MANUAL, AI_SUGGESTED

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("trust_events")
}

model TenantTrustProfile {
  id        String @id @default(uuid())
  userRefId String @unique
  user      User   @relation(fields: [userRefId], references: [id])
  tti_score Float  @default(50.0)

  kyc_status    String    @default("PENDING")
  ktpUrl        String?
  ktpVerifiedAt DateTime?
  selfieUrl     String?

  payment_faults Int @default(0)

  logs TrustLog[]

  @@map("tenant_profiles")
}

model LandlordTrustProfile {
  id            String @id @default(uuid())
  userRefId     String @unique
  user          User   @relation(fields: [userRefId], references: [id])
  lrs_score     Float  @default(50.0)
  response_rate Float  @default(0.0)

  kyc_status    String    @default("PENDING")
  ktpUrl        String?
  ktpVerifiedAt DateTime?

  logs TrustLog[]

  @@map("landlord_profiles")
}

model TrustLog {
  id            String  @id @default(uuid())
  eventCode     String
  impact        Float
  scoreSnapshot Float   // [UPDATED] Renamed from scoreSnap for clarity
  description   String?
  evidenceUrl   String?

  // [NEW] Audit & Context Fields
  referenceId   String? // e.g. BookingID, PaymentID
  referenceType String? // "BOOKING", "PAYMENT", "MANUAL", "DISPUTE"
  actor         String  @default("SYSTEM") // "SYSTEM", "ADMIN:<id>", "AI_AGENT"
  metadata      Json?   // Arbitrary context: { "latency": 250, "ai_confidence": 0.98 }

  tenantId   String?
  tenant     TenantTrustProfile?   @relation(fields: [tenantId], references: [id])
  landlordId String?
  landlord   LandlordTrustProfile? @relation(fields: [landlordId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([landlordId])
  @@index([createdAt])
  @@map("trust_logs")
}

// =========================================================
// 5. MODULE: CHAT & COMMUNICATION
// =========================================================

model ChatRoom {
  id            String        @id @default(uuid())
  propertyId    String?
  property      Property?     @relation(fields: [propertyId], references: [id])
  tenantId      String
  landlordId    String
  tenant        User          @relation("TenantChats", fields: [tenantId], references: [id])
  landlord      User          @relation("LandlordChats", fields: [landlordId], references: [id])
  messages      ChatMessage[]
  lastMessageAt DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([tenantId])
  @@index([landlordId])
  @@index([lastMessageAt])
  @@map("chat_rooms")
}

model ChatMessage {
  id        String   @id @default(uuid())
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id])
  senderId  String
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([createdAt])
  @@map("chat_messages")
}