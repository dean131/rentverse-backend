// =========================================================
// RENTVERSE DATABASE SCHEMA (v5.5 - FINAL REVERTED)
// =========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// 1. MODULE: IDENTITY & ACCESS
// =========================================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  emailVerifiedAt DateTime?
  phone           String?   @unique
  phoneVerifiedAt DateTime?
  name            String?
  password        String
  avatarUrl       String?
  isVerified      Boolean   @default(false)
  metadata        Json?

  roles           UserRole[]
  tenantProfile   TenantTrustProfile?
  landlordProfile LandlordTrustProfile?
  favorites       UserFavorite[]
  devices         UserDevice[]

  tenantChats     ChatRoom[]            @relation("TenantChats")
  landlordChats   ChatRoom[]            @relation("LandlordChats")
  
  bookings        Booking[]
  properties      Property[]            @relation("LandlordProperties")
  wallet          Wallet?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  @@map("users")
  @@index([email])
}

model UserDevice {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fcmToken     String   @unique
  platform     String   
  deviceModel  String?  
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@map("user_devices")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique 
  description String?
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  action      String           @unique
  description String?
  roles       RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =========================================================
// 2. MODULE: RENTAL & MARKETPLACE
// =========================================================

model PropertyType {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  label      String
  properties Property[]

  @@map("ref_property_types")
}

model ListingType {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  label      String
  properties Property[]

  @@map("ref_listing_types")
}

model BillingPeriod {
  id             Int                     @id @default(autoincrement())
  slug           String                  @unique
  label          String
  durationMonths Int
  bookings       Booking[]
  properties     PropertyBillingPeriod[]

  @@map("ref_billing_periods")
}

model PropertyAttributeType {
  id       Int                 @id @default(autoincrement())
  slug     String              @unique
  label    String
  dataType String
  iconUrl  String?
  values   PropertyAttribute[]

  @@map("ref_property_attribute_types")
}

model PropertyAttribute {
  id              String                @id @default(uuid())
  propertyId      String
  property        Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  attributeTypeId Int
  attributeType   PropertyAttributeType @relation(fields: [attributeTypeId], references: [id])
  value           String

  @@unique([propertyId, attributeTypeId])
  @@map("property_attributes")
}

model Property {
  id          String  @id @default(uuid())
  landlordId  String
  landlord    User    @relation("LandlordProperties", fields: [landlordId], references: [id])
  
  title       String
  description String? @db.Text

  propertyTypeId Int
  propertyType   PropertyType @relation(fields: [propertyTypeId], references: [id])

  attributes PropertyAttribute[]
  amenities  String[] @default([])

  address   String
  city      String
  country   String
  latitude  Float?
  longitude Float?

  listingTypeId Int
  listingType   ListingType @relation(fields: [listingTypeId], references: [id])
  
  price         Decimal     @db.Decimal(15, 2)
  currency      String      @default("IDR") // [REVERTED] Just a string
  isVerified    Boolean     @default(false)

  metadata Json?

  allowedBillingPeriods PropertyBillingPeriod[]
  images                PropertyImage[]
  bookings              Booking[]
  chatRooms             ChatRoom[]
  favoritedBy           UserFavorite[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([city])
  @@index([price])
  @@map("properties")
}

model PropertyBillingPeriod {
  propertyId      String
  billingPeriodId Int
  property        Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  billingPeriod   BillingPeriod @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)

  @@id([propertyId, billingPeriodId])
  @@map("property_billing_periods")
}

model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  url        String
  isPrimary  Boolean  @default(false)

  @@map("property_images")
}

model UserFavorite {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@map("user_favorites")
}

// =========================================================
// 3. MODULE: PAYMENT & BOOKING
// =========================================================

model Booking {
  id    String @id @default(uuid())
  
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])
  tenantId   String
  tenant     User     @relation(fields: [tenantId], references: [id])

  billingPeriodId Int
  billingPeriod   BillingPeriod @relation(fields: [billingPeriodId], references: [id])

  startDate       DateTime
  endDate         DateTime?
  nextPaymentDate DateTime
  status          String 

  invoices Invoice[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([tenantId])
  @@map("bookings")
}

model Invoice {
  id              String    @id @default(uuid())
  bookingId       String
  booking         Booking   @relation(fields: [bookingId], references: [id])
  
  amount          Decimal   @db.Decimal(15, 2)
  currency        String    @default("IDR") // [REVERTED] Just a string

  dueDate         DateTime
  paidAt          DateTime?
  status          String    
  paymentLink     String?
  snapToken       String?
  midtransOrderId String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
}

// =========================================================
// 4. MODULE: TRUST ENGINE
// =========================================================

model TrustEvent {
  id          String   @id @default(uuid())
  code        String   @unique
  category    String
  role        String
  baseImpact  Float
  description String?
  sourceType  String   @default("AUTOMATED")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("trust_events")
}

model TenantTrustProfile {
  id        String @id @default(uuid())
  userRefId String @unique
  user      User   @relation(fields: [userRefId], references: [id])
  tti_score Float  @default(50.0)
  kyc_status    String    @default("PENDING")
  ktpUrl        String?
  ktpVerifiedAt DateTime?
  selfieUrl     String?
  payment_faults Int @default(0)
  logs TrustLog[]

  @@map("tenant_profiles")
}

model LandlordTrustProfile {
  id            String @id @default(uuid())
  userRefId     String @unique
  user          User   @relation(fields: [userRefId], references: [id])
  lrs_score     Float  @default(50.0)
  response_rate Float  @default(0.0)
  kyc_status    String    @default("PENDING")
  ktpUrl        String?
  ktpVerifiedAt DateTime?
  logs TrustLog[]

  @@map("landlord_profiles")
}

model TrustLog {
  id            String  @id @default(uuid())
  eventCode     String
  impact        Float
  scoreSnapshot Float   
  description   String?
  evidenceUrl   String?
  referenceId   String? 
  referenceType String? 
  actor         String  @default("SYSTEM") 
  metadata      Json?   

  tenantId   String?
  tenant     TenantTrustProfile? @relation(fields: [tenantId], references: [id])
  landlordId String?
  landlord   LandlordTrustProfile? @relation(fields: [landlordId], references: [id])

  createdAt DateTime @default(now())

  @@map("trust_logs")
}

// =========================================================
// 5. MODULE: CHAT
// =========================================================

model ChatRoom {
  id            String        @id @default(uuid())
  propertyId    String?
  property      Property?     @relation(fields: [propertyId], references: [id])
  tenantId      String
  landlordId    String
  tenant        User          @relation("TenantChats", fields: [tenantId], references: [id])
  landlord      User          @relation("LandlordChats", fields: [landlordId], references: [id])
  messages      ChatMessage[]
  lastMessageAt DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("chat_rooms")
}

model ChatMessage {
  id        String   @id @default(uuid())
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id])
  senderId  String
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("chat_messages")
}

// =========================================================
// 6. MODULE: FINANCE
// =========================================================

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  balance   Decimal  @default(0) @db.Decimal(15, 2)
  currency  String   @default("IDR") // [REVERTED] Just a string
  
  transactions WalletTransaction[]
  payouts      PayoutRequest[]

  updatedAt DateTime @updatedAt
  @@map("wallets")
}

model WalletTransaction {
  id          String   @id @default(uuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  type        String   
  category    String   
  description String?
  referenceId String?  
  balanceAfter Decimal @db.Decimal(15, 2)
  createdAt   DateTime @default(now())

  @@map("wallet_transactions")
}

model PayoutRequest {
  id          String   @id @default(uuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  status      String   @default("PENDING") 
  bankName    String
  accountNo   String
  accountName String
  processedAt DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payout_requests")
}